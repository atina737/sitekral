<!DOCTYPE html>
<html lang="tr">
{% include 'includes/head.html' %}

<body>
    <!-- Begin page -->
    <div class="wrapper">
        
        {% include 'includes/sidebar.html' %}
        {% include 'includes/topbar.html' %}

        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->
        <div class="page-content">
            <div class="page-container">

                <div class="page-title-head d-flex align-items-center gap-2">
                    <div class="flex-grow-1">
                        <h4 class="fs-17 mb-0">Kullanıcılar</h4>
                    </div>
                    <div class="text-end">
                        <ol class="breadcrumb m-0 py-0 fs-13">
                            <li class="breadcrumb-item"><a href="javascript: void(0);">{{ session.user_name }}</a></li>
                            <li class="breadcrumb-item"><a href="javascript: void(0);">Admin</a></li>
                            <li class="breadcrumb-item active">Kullanıcılar</li>
                        </ol>
                    </div>
                </div>

                <!-- Alert Box -->
                <div id="userAlert" class="alert alert-danger d-none" role="alert"></div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header border-bottom card-tabs d-flex flex-wrap align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <h4 class="card-title">Kullanıcı Yönetimi</h4>
                                </div>
                                <div class="d-flex gap-2">
                                    <div class="border rounded d-flex flex-row align-items-center" id="top-search">
                                        <i class="ti ti-search text-muted fs-18 ps-2"></i>
                                        <input type="search" class="form-control border-0" id="search-modal-input" placeholder="Kullanıcı ara...">
                                    </div>
                                    <button type="button" class="btn btn-success shadow-sm rounded-pill d-flex align-items-center px-3" data-bs-toggle="modal" data-bs-target="#createUserModal">
                                        <i class="ti ti-user-plus me-2"></i>
                                        <span>Yeni Üye Oluştur</span>
                                    </button>
                                </div>
                            </div>

                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-custom table-centered table-sm table-nowrap table-hover mb-0 user-table">
                                        <thead>
                                            <tr>
                                                <th>Kullanıcı</th>
                                                <th>E-posta</th>
                                                <th>Rol</th>
                                                <th>Durum</th>
                                                <th>Kayıt Tarihi</th>
                                                <th>Son Giriş</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if users and users|length > 0 %}
                                                {% for user in users %}
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <div class="avatar-md flex-shrink-0 me-2">
                                                                    <span class="avatar-title avatar-soft-primary rounded-circle fw-semibold">
                                                                        {{ user.name[0].upper() if user.name else 'U' }}
                                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <h5 class="fs-14 mb-0">{{ user.name or 'Bilinmiyor' }}</h5>
                                                                    <small class="text-muted">{{ user.username or 'Kullanıcı adı yok' }}</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="text-muted">{{ user.email }}</span>
                                                        </td>
                                                        <td>
                                                            {% if user.role == 'admin' %}
                                                                <span class="badge badge-primary-soft">Admin</span>
                                                            {% else %}
                                                                <span class="badge badge-warning-soft">Kullanıcı</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            <span class="status-dot {% if user.email in online_users %}online{% else %}offline{% endif %}"></span>
                                                            {% if user.email in online_users %}Çevrimiçi{% else %}Çevrimdışı{% endif %}
                                                        </td>
                                                        <td>
                                                            <small class="text-muted">{{ user.createdAt[:10] if user.createdAt else 'Bilinmiyor' }}</small>
                                                        </td>
                                                        <td>
                                                            <small class="text-muted">{{ user.lastLoginAt[:10] if user.lastLoginAt else 'Hiç giriş yapmamış' }}</small>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex gap-1">
                                                                <button class="btn btn-sm btn-outline-primary btn-icon" onclick="editUser('{{ user.email }}')" title="Düzenle">
                                                                    <i class="ti ti-edit"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-danger btn-icon" onclick="deleteUser('{{ user.email }}')" title="Sil">
                                                                    <i class="ti ti-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="7" class="text-center py-4">
                                                        <div class="text-muted">
                                                            <i class="ti ti-users-off fs-1 mb-2 d-block"></i>
                                                            Henüz kullanıcı bulunmuyor
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        {% include 'includes/footer.html' %}
    </div>

    <!-- Yeni Kullanıcı Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yeni Kullanıcı Oluştur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="userName" class="form-label">Ad Soyad <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="userName" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="userUsername" class="form-label">Kullanıcı Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="userUsername" name="username" required>
                            </div>
                            <div class="col-md-6">
                                <label for="userEmail" class="form-label">E-posta <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="userEmail" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="userPassword" class="form-label">Şifre <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="userPassword" name="password" required>
                            </div>
                            <div class="col-md-6">
                                <label for="userRole" class="form-label">Rol</label>
                                <select class="form-select" id="userRole" name="role">
                                    <option value="user">Kullanıcı</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">Kullanıcı Oluştur</button>
                </div>
            </div>
        </div>
    </div>

    {% include 'includes/footer_scripts.html' %}

    <style>
        .user-table thead th { 
            position: sticky; 
            top: 0; 
            z-index: 1; 
            background: var(--ct-body-bg); 
            border-bottom: 1px solid var(--ct-border-color, rgba(108,117,125,.2)); 
        }
        .user-table { 
            border-collapse: separate; 
            border-spacing: 0; 
        }
        .user-table tbody tr { 
            border-bottom: 1px solid var(--ct-border-color, rgba(108,117,125,.2)); 
        }
        .user-table tbody tr:last-child { 
            border-bottom: 0; 
        }
        .user-table td, .user-table th { 
            border: 0 !important; 
            vertical-align: middle; 
        }
        .user-table .avatar-title { 
            width: 32px; 
            height: 32px; 
            font-size: 14px; 
        }
        .user-table .badge-primary-soft { 
            background: rgba(13,110,253,.08); 
            color: #0d6efd; 
            border: 1px solid rgba(13,110,253,.15); 
            font-size: 12px; 
            padding: .25rem .5rem; 
        }
        .user-table .badge-warning-soft { 
            background: rgba(255,193,7,.12); 
            color: #f59f00; 
            border: 1px solid rgba(255,193,7,.2); 
            font-size: 12px; 
            padding: .25rem .5rem; 
        }
        .user-table .avatar-soft-primary { 
            background: rgba(13,110,253,.12) !important; 
            color: #0d6efd !important; 
        }
        .user-table .status-dot { 
            width:10px; 
            height:10px; 
            border-radius:50%; 
            display:inline-block; 
        }
        .user-table .status-dot.online { 
            background:#16c79a; 
        }
        .user-table .status-dot.offline { 
            background:#adb5bd; 
        }
        .user-table .btn-icon { 
            width: 32px; 
            height: 32px; 
            padding: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
    </style>

    <script>
        function createUser() {
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            
            fetch('/admin/users/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken
                },
                body: JSON.stringify({
                    name: formData.get('name'),
                    username: formData.get('username'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: formData.get('role')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata oluştu');
            });
        }

        function editUser(email) {
            // Düzenleme modal'ı açılacak
            alert('Düzenleme özelliği yakında eklenecek: ' + email);
        }

        function deleteUser(email) {
            if (confirm('Bu kullanıcıyı silmek istediğinizden emin misiniz?')) {
                fetch('/admin/users/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken
                    },
                    body: JSON.stringify({ email: email })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        location.reload();
                    } else {
                        alert('Hata: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Bir hata oluştu');
                });
            }
        }
    </script>

</body>
</html>
