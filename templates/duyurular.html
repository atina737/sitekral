<!DOCTYPE html>
<html lang="tr">
{% include 'includes/head.html' %}

<body>
    <!-- Begin page -->
    <div class="wrapper">
        {% include 'includes/sidebar.html' %}
        {% include 'includes/topbar.html' %}

        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->
        <div class="page-content">
            <div class="page-container">
                <div class="page-title-head d-flex align-items-center gap-2">
                    <div class="flex-grow-1">
                        <h4 class="fs-17 mb-0">Duyuru Yönetimi</h4>
                    </div>

                    <div class="text-end">
                        <ol class="breadcrumb m-0 py-0 fs-13">
                            <li class="breadcrumb-item"><a href="javascript: void(0);">{{ session.user_name }}</a></li>
                            <li class="breadcrumb-item"><a href="javascript: void(0);">Admin</a></li>
                        </ol>
                    </div>
                </div>

                <!-- Alert Box -->
                <div id="adminDuyuruAlert" class="alert alert-danger d-none" role="alert"></div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header border-bottom card-tabs d-flex flex-wrap align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <h4 class="card-title">Duyuru Yönetimi</h4>
                                </div>
                                <div class="d-flex gap-2">
                                    <div class="border rounded d-flex flex-row align-items-center" id="top-search">
                                        <i class="ti ti-search text-muted fs-18 ps-2"></i>
                                        <input type="search" class="form-control border-0" id="search-modal-input" placeholder="Duyuru ara...">
                                    </div>
                                    <button type="button" class="btn btn-success shadow-sm rounded-pill d-flex align-items-center px-3" data-bs-toggle="modal" data-bs-target="#createDuyuruModal" title="Yeni duyuru ekle">
                                        <i class="ti ti-plus me-2"></i>
                                        <span>Yeni Duyuru Ekle</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Duyurular tablosu -->
                            <style>
                                /* Tablonun görsel düzeni: tek renk, net ikonlar */
                                .duyuru-table thead th { position: sticky; top: 0; z-index: 1; background: var(--ct-body-bg); border-bottom: 1px solid var(--ct-border-color, rgba(108,117,125,.2)); }
                                /* Yamuk çizgi düzeltmeleri */
                                .duyuru-table { border-collapse: separate; border-spacing: 0; }
                                .duyuru-table tbody tr { border-bottom: 1px solid var(--ct-border-color, rgba(108,117,125,.2)); }
                                .duyuru-table tbody tr:last-child { border-bottom: 0; }
                                .duyuru-table td, .duyuru-table th { border: 0 !important; vertical-align: middle; }
                                .duyuru-table .avatar-title { width: 32px; height: 32px; font-size: 14px; }
                                .duyuru-table .type-badge { background: rgba(13,110,253,.08); color: #0d6efd; border: 1px solid rgba(13,110,253,.15); padding: .35rem .55rem; font-weight: 600; display: inline-flex; align-items: center; gap: .35rem; font-size: 13px; border-radius: .5rem; }
                                .duyuru-table .badge-primary-soft { background: rgba(13,110,253,.08); color: #0d6efd; border: 1px solid rgba(13,110,253,.15); }
                                .duyuru-table .badge-warning-soft { background: rgba(255,193,7,.12); color: #f59f00; border: 1px solid rgba(255,193,7,.2); }
                                .duyuru-table .badge-danger-soft { background: rgba(220,53,69,.12); color: #dc3545; border: 1px solid rgba(220,53,69,.2); }
                                .duyuru-table .badge-success-soft { background: rgba(25,135,84,.12); color: #198754; border: 1px solid rgba(25,135,84,.2); }
                                .duyuru-table .badge-primary-soft { font-size: 12px; padding: .25rem .5rem; }
                                .duyuru-table .avatar-soft-primary { background: rgba(13,110,253,.12) !important; color: #0d6efd !important; }
                                .duyuru-table .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
                                .duyuru-table .status-dot.active { background:#16c79a; }
                                .duyuru-table .status-dot.inactive { background:#adb5bd; }
                                
                                /* İşlemler sütunu düzeltmeleri */
                                .duyuru-table td:last-child { 
                                    width: 140px; 
                                    min-width: 140px; 
                                    max-width: 140px; 
                                    padding: 0.75rem 0.5rem !important; 
                                }
                                
                                /* Buton hizalaması */
                                .duyuru-table .btn-icon { 
                                    width: 32px; 
                                    height: 32px; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    padding: 0; 
                                }
                            </style>

                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 duyuru-table">
                                        <thead>
                                            <tr>
                                                <th class="fs-12 text-uppercase text-muted">Başlık</th>
                                                <th class="fs-12 text-uppercase text-muted">Tür</th>
                                                <th class="fs-12 text-uppercase text-muted">Durum</th>
                                                <th class="fs-12 text-uppercase text-muted">Oluşturan</th>
                                                <th class="fs-12 text-uppercase text-muted">Tarih</th>
                                                <th class="fs-12 text-uppercase text-muted">İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody id="duyuruTableBody">
                                            <!-- Duyurular buraya yüklenecek -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yeni Duyuru Oluştur Modal -->
                <div class="modal fade" id="createDuyuruModal" tabindex="-1" aria-labelledby="createDuyuruModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="createDuyuruModalLabel">Yeni Duyuru Oluştur</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createDuyuruForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="createDuyuruTitle" class="form-label">Başlık</label>
                                            <input type="text" class="form-control" id="createDuyuruTitle" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="createDuyuruType" class="form-label">Tür</label>
                                            <select class="form-select" id="createDuyuruType" required>
                                                <option value="Genel">Genel</option>
                                                <option value="Bakım">Bakım</option>
                                                <option value="Güncelleme">Güncelleme</option>
                                                <option value="Önemli">Önemli</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="createDuyuruIcon" class="form-label">İkon</label>
                                            <select class="form-select" id="createDuyuruIcon">
                                                <option value="ti-bell">Bell (Zil)</option>
                                                <option value="ti-info-circle">Info (Bilgi)</option>
                                                <option value="ti-alert-triangle">Warning (Uyarı)</option>
                                                <option value="ti-check-circle">Success (Başarı)</option>
                                                <option value="ti-x-circle">Error (Hata)</option>
                                                <option value="ti-star">Star (Yıldız)</option>
                                                <option value="ti-heart">Heart (Kalp)</option>
                                                <option value="ti-settings">Settings (Ayarlar)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="createDuyuruActive" class="form-label">Durum</label>
                                            <select class="form-select" id="createDuyuruActive">
                                                <option value="true">Aktif</option>
                                                <option value="false">Pasif</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label for="createDuyuruText" class="form-label">İçerik</label>
                                            <textarea class="form-control" id="createDuyuruText" rows="4" required></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="button" class="btn btn-primary" id="createDuyuruBtn">Duyuru Oluştur</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duyuru Düzenle Modal -->
                <div class="modal fade" id="editDuyuruModal" tabindex="-1" aria-labelledby="editDuyuruModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editDuyuruModalLabel">Duyuru Düzenle</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editDuyuruForm">
                                    <input type="hidden" id="editDuyuruId">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="editDuyuruTitle" class="form-label">Başlık</label>
                                            <input type="text" class="form-control" id="editDuyuruTitle" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editDuyuruType" class="form-label">Tür</label>
                                            <select class="form-select" id="editDuyuruType" required>
                                                <option value="Genel">Genel</option>
                                                <option value="Bakım">Bakım</option>
                                                <option value="Güncelleme">Güncelleme</option>
                                                <option value="Önemli">Önemli</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editDuyuruIcon" class="form-label">İkon</label>
                                            <select class="form-select" id="editDuyuruIcon">
                                                <option value="ti-bell">Bell (Zil)</option>
                                                <option value="ti-info-circle">Info (Bilgi)</option>
                                                <option value="ti-alert-triangle">Warning (Uyarı)</option>
                                                <option value="ti-check-circle">Success (Başarı)</option>
                                                <option value="ti-x-circle">Error (Hata)</option>
                                                <option value="ti-star">Star (Yıldız)</option>
                                                <option value="ti-heart">Heart (Kalp)</option>
                                                <option value="ti-settings">Settings (Ayarlar)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editDuyuruActive" class="form-label">Durum</label>
                                            <select class="form-select" id="editDuyuruActive">
                                                <option value="true">Aktif</option>
                                                <option value="false">Pasif</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label for="editDuyuruText" class="form-label">İçerik</label>
                                            <textarea class="form-control" id="editDuyuruText" rows="4" required></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="button" class="btn btn-primary" id="updateDuyuruBtn">Güncelle</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- container -->
        </div>
        <!-- content -->

        {% include 'includes/footer.html' %}
    </div>
    <!-- END wrapper -->

    {% include 'includes/footer_scripts.html' %}

    <script>
    let duyurular = [];

    // Custom Alert System
    function showAlert(message, type = 'success') {
        const alertBox = document.getElementById('adminDuyuruAlert');
        if (!alertBox) return;
        
        alertBox.textContent = message || '';
        alertBox.className = `alert alert-${type}`;
        alertBox.classList.remove('d-none');
        
        setTimeout(() => {
            alertBox.classList.add('d-none');
        }, 4000);
    }

    // Toast function
    function toast(message, type = 'info') {
        const msg = (typeof message === 'string' && message) ? message : (type === 'success' ? 'İşlem başarılı.' : 'İşlem başarısız.');
        showAlert(msg, type);
    }

    // Load duyurular
    async function loadDuyurular() {
        try {
            const response = await fetch('/api/duyurular');
            const data = await response.json();
            if (data.ok) {
                duyurular = data.duyurular || [];
                renderDuyurular();
            } else {
                toast('Duyurular yüklenemedi', 'error');
            }
        } catch (error) {
            console.error('Duyurular yüklenemedi:', error);
            toast('Bir hata oluştu', 'error');
        }
    }

    // Render duyurular
    function renderDuyurular() {
        const tbody = document.getElementById('duyuruTableBody');
        if (!tbody) return;

        if (!duyurular.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">
                            <i class="ti ti-bell fs-1 mb-3 d-block"></i>
                            <h5>Henüz duyuru bulunmuyor</h5>
                            <p>Yeni duyuru eklemek için yukarıdaki butonu kullanın.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = duyurular.map(duyuru => `
            <tr>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                            <i class="${duyuru.icon || 'ti-bell'}"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">${duyuru.title}</div>
                            <small class="text-muted">${duyuru.text.substring(0, 50)}...</small>
                        </div>
                    </div>
                </td>
                <td><span class="badge badge-primary-soft">${duyuru.type}</span></td>
                <td>
                    <span class="badge ${duyuru.active ? 'badge-success-soft' : 'badge-warning-soft'}">
                        <span class="status-dot ${duyuru.active ? 'active' : 'inactive'} me-1"></span>
                        ${duyuru.active ? 'Aktif' : 'Pasif'}
                    </span>
                </td>
                <td><small class="text-muted">${duyuru.admin || 'Admin'}</small></td>
                <td><small class="text-muted">${formatDate(duyuru.createdAt || duyuru.date)}</small></td>
                <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-1">
                        <button class="btn btn-outline-warning btn-sm btn-icon btn-edit" data-duyuru-id="${duyuru.id}" title="Düzenle">
                            <i class="ti ti-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-icon btn-delete" data-duyuru-id="${duyuru.id}" title="Sil">
                            <i class="ti ti-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Format date
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('tr-TR', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Edit duyuru button handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-edit')) {
            const btn = e.target.closest('.btn-edit');
            const duyuruId = btn.dataset.duyuruId;
            const duyuru = duyurular.find(d => d.id === duyuruId);
            if (!duyuru) return;

            document.getElementById('editDuyuruId').value = duyuru.id;
            document.getElementById('editDuyuruTitle').value = duyuru.title;
            document.getElementById('editDuyuruType').value = duyuru.type;
            document.getElementById('editDuyuruIcon').value = duyuru.icon || 'ti-bell';
            document.getElementById('editDuyuruActive').value = duyuru.active.toString();
            document.getElementById('editDuyuruText').value = duyuru.text;

            const modal = new bootstrap.Modal(document.getElementById('editDuyuruModal'));
            modal.show();
        }
    });

    // Delete duyuru button handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-delete')) {
            const btn = e.target.closest('.btn-delete');
            const duyuruId = btn.dataset.duyuruId;
            
            if (!window.Swal) {
                return toast('SweetAlert2 yüklü değil!', 'error');
            }

            Swal.fire({
                title: 'Emin misiniz?',
                text: 'Bu duyuru silinecek!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, sil!',
                cancelButtonText: 'İptal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/api/duyurular/${duyuruId}`, {
                            method: 'DELETE'
                        });

                        const data = await response.json();
                        if (data.ok) {
                            Swal.fire('Silindi!', 'Duyuru başarıyla silindi.', 'success');
                            loadDuyurular();
                        } else {
                            Swal.fire('Hata!', 'Duyuru silinemedi: ' + data.message, 'error');
                        }
                    } catch (error) {
                        console.error('Silme hatası:', error);
                        Swal.fire('Hata!', 'Duyuru silinirken bir hata oluştu', 'error');
                    }
                }
            });
        }
    });

    // Create duyuru button handler
    document.getElementById('createDuyuruBtn').addEventListener('click', async function() {
        const title = document.getElementById('createDuyuruTitle').value.trim();
        const type = document.getElementById('createDuyuruType').value;
        const icon = document.getElementById('createDuyuruIcon').value;
        const active = document.getElementById('createDuyuruActive').value === 'true';
        const text = document.getElementById('createDuyuruText').value.trim();

        if (!title || !text) {
            toast('Başlık ve içerik alanları zorunludur', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/duyurular', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title,
                    type,
                    icon,
                    active,
                    text
                })
            });

            const data = await response.json();
            if (data.ok) {
                toast('Duyuru başarıyla eklendi', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('createDuyuruModal'));
                modal.hide();
                document.getElementById('createDuyuruForm').reset();
                loadDuyurular();
            } else {
                toast('Duyuru eklenemedi: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Duyuru ekleme hatası:', error);
            toast('Bir hata oluştu', 'error');
        }
    });

    // Update duyuru button handler
    document.getElementById('updateDuyuruBtn').addEventListener('click', async function() {
        const id = document.getElementById('editDuyuruId').value;
        const title = document.getElementById('editDuyuruTitle').value.trim();
        const type = document.getElementById('editDuyuruType').value;
        const icon = document.getElementById('editDuyuruIcon').value;
        const active = document.getElementById('editDuyuruActive').value === 'true';
        const text = document.getElementById('editDuyuruText').value.trim();

        if (!title || !text) {
            toast('Başlık ve içerik alanları zorunludur', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/duyurular/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title,
                    type,
                    icon,
                    active,
                    text
                })
            });

            const data = await response.json();
            if (data.ok) {
                toast('Duyuru başarıyla güncellendi', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDuyuruModal'));
                modal.hide();
                loadDuyurular();
            } else {
                toast('Duyuru güncellenemedi: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Duyuru güncelleme hatası:', error);
            toast('Bir hata oluştu', 'error');
        }
    });

    // Search function
    function searchDuyurular() {
        const searchTerm = document.getElementById('search-modal-input').value.toLowerCase();
        const filtered = duyurular.filter(duyuru => 
            duyuru.title.toLowerCase().includes(searchTerm) ||
            duyuru.text.toLowerCase().includes(searchTerm) ||
            duyuru.type.toLowerCase().includes(searchTerm) ||
            (duyuru.admin || '').toLowerCase().includes(searchTerm)
        );
        
        const tbody = document.getElementById('duyuruTableBody');
        if (!tbody) return;

        if (!filtered.length && searchTerm) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">
                            <i class="ti ti-search-off fs-1 mb-3 d-block"></i>
                            <h5>Arama sonucu bulunamadı</h5>
                            <p>"${searchTerm}" için sonuç bulunamadı.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        if (!filtered.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">
                            <i class="ti ti-bell fs-1 mb-3 d-block"></i>
                            <h5>Henüz duyuru bulunmuyor</h5>
                            <p>Yeni duyuru eklemek için yukarıdaki butonu kullanın.</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = filtered.map(duyuru => `
            <tr>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                            <i class="${duyuru.icon || 'ti-bell'}"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">${duyuru.title}</div>
                            <small class="text-muted">${duyuru.text.substring(0, 50)}...</small>
                        </div>
                    </div>
                </td>
                <td><span class="badge badge-primary-soft">${duyuru.type}</span></td>
                <td>
                    <span class="badge ${duyuru.active ? 'badge-success-soft' : 'badge-warning-soft'}">
                        <span class="status-dot ${duyuru.active ? 'active' : 'inactive'} me-1"></span>
                        ${duyuru.active ? 'Aktif' : 'Pasif'}
                    </span>
                </td>
                <td><small class="text-muted">${duyuru.admin || 'Admin'}</small></td>
                <td><small class="text-muted">${formatDate(duyuru.createdAt || duyuru.date)}</small></td>
                <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-1">
                        <button class="btn btn-outline-warning btn-sm btn-icon btn-edit" data-duyuru-id="${duyuru.id}" title="Düzenle">
                            <i class="ti ti-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-icon btn-delete" data-duyuru-id="${duyuru.id}" title="Sil">
                            <i class="ti ti-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // URL hash'ini temizle
        if (window.location.hash) {
            window.history.replaceState(null, null, window.location.pathname);
        }
        
        loadDuyurular();
        
        // Search
        document.getElementById('search-modal-input').addEventListener('input', searchDuyurular);
    });
    </script>

</body>
</html>
