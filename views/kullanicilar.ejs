<!DOCTYPE html>
<html lang="en">

<head>
 <%- include('includes/head') %>
 
</head>

<body>
    <!-- Begin page -->
    <div class="wrapper">

        
        <%- include('includes/sidebar') %>
        

                <%- include('includes/topbar') %>

                

        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->
        <div class="page-content">

            <div class="page-container">

                
                <div class="page-title-head d-flex align-items-center gap-2">
                    <div class="flex-grow-1">
                        <h4 class="fs-17 mb-0">Kullanıcılar</h4>
                    </div>

                    <div class="text-end">
                        <ol class="breadcrumb m-0 py-0 fs-13">
                            <li class="breadcrumb-item"><a href="javascript: void(0);"><%= name %></a></li>
                            
                            <li class="breadcrumb-item"><a href="javascript: void(0);">Invoice</a></li>
                            
                           
                        </ol>
                    </div>
                </div>

                <!-- Alert Box -->
                <div id="userAlert" class="alert alert-danger d-none" role="alert"></div>

                
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header border-bottom card-tabs d-flex flex-wrap align-items-center gap-2">
                <div class="flex-grow-1">
                    <h4 class="card-title">Kullanıcı Yönetimi</h4>
                </div>
                <div class="d-flex gap-2">
                    <div class="border rounded d-flex flex-row align-items-center" id="top-search">
                        <i class="ti ti-search text-muted fs-18 ps-2"></i>
                        <input type="search" class="form-control border-0" id="search-modal-input" placeholder="Kullanıcı ara...">
                    </div>
                    <button type="button" class="btn btn-success shadow-sm rounded-pill d-flex align-items-center px-3" data-bs-toggle="modal" data-bs-target="#createUserModal" data-bs-toggle-second="tooltip" title="Yeni kullanıcı ekle">
                        <i class="ti ti-user-plus me-2"></i>
                        <span>Yeni Üye Oluştur</span>
                    </button>
                </div>
            </div>

        

           <!-- Kullanıcılar tablosu -->
<style>
    /* Tablonun görsel düzeni: tek renk, net ikonlar */
    .user-table thead th { position: sticky; top: 0; z-index: 1; background: var(--ct-body-bg); border-bottom: 1px solid var(--ct-border-color, rgba(108,117,125,.2)); }
    /* Yamuk çizgi düzeltmeleri */
    .user-table { border-collapse: separate; border-spacing: 0; }
    .user-table tbody tr { border-bottom: 1px solid var(--ct-border-color, rgba(108,117,125,.2)); }
    .user-table tbody tr:last-child { border-bottom: 0; }
    .user-table td, .user-table th { border: 0 !important; vertical-align: middle; }
    .user-table .avatar-title { width: 32px; height: 32px; font-size: 14px; }
    .user-table .balance-badge { background: rgba(13,110,253,.08); color: #0d6efd; border: 1px solid rgba(13,110,253,.15); padding: .35rem .55rem; font-weight: 600; display: inline-flex; align-items: center; gap: .35rem; font-size: 13px; border-radius: .5rem; }
    .user-table .badge-primary-soft { background: rgba(13,110,253,.08); color: #0d6efd; border: 1px solid rgba(13,110,253,.15); }
    .user-table .badge-warning-soft { background: rgba(255,193,7,.12); color: #f59f00; border: 1px solid rgba(255,193,7,.2); }
    .user-table .badge-danger-soft { background: rgba(220,53,69,.12); color: #dc3545; border: 1px solid rgba(220,53,69,.2); }
    .user-table .badge-primary-soft { font-size: 12px; padding: .25rem .5rem; }
    .user-table .avatar-soft-primary { background: rgba(13,110,253,.12) !important; color: #0d6efd !important; }
    .user-table .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .user-table .status-dot.online { background:#16c79a; }
    .user-table .status-dot.offline { background:#adb5bd; }
    
    /* İşlemler sütunu düzeltmeleri */
    .user-table td:last-child { 
        width: 140px; 
        min-width: 140px; 
        max-width: 140px; 
        padding: 0.75rem 0.5rem !important; 
    }
    
    /* Buton hizalaması */
    .user-table .btn-icon { 
        width: 32px; 
        height: 32px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 0; 
    }
</style>
<div class="table-responsive">
    <table class="table table-hover align-middle text-nowrap mb-0 user-table" id="usersTable">
        <thead class="bg-light-subtle">
            <tr>
                <th class="ps-3" style="width: 50px;">
                    <input type="checkbox" class="form-check-input" id="customCheck1">
                </th>
                <th class="fs-12 text-uppercase text-muted">Kullanıcı</th>
                <th class="fs-12 text-uppercase text-muted">Rol</th>
                <th class="fs-12 text-uppercase text-muted">Email</th>
                <th class="fs-12 text-uppercase text-muted">İp</th>
                <th class="fs-12 text-uppercase text-muted">Kayıt</th>
                <th class="fs-12 text-uppercase text-muted">Son Giriş</th>
                <th class="fs-12 text-uppercase text-muted">Bakiye</th>
                <th class="fs-12 text-uppercase text-muted">Sorgu Hakkı</th>
                <th class="fs-12 text-uppercase text-muted">Durum</th>
                <th class="text-center fs-12 text-uppercase text-muted" style="width: 140px;">İşlemler</th>
            </tr>
        </thead>
        <tbody>
            <% users.forEach(function(user) { %>
                <tr data-user-id="<%= user.id %>" data-role="<%= Number(user.role) %>" data-online="<%= onlineEmails.includes(user.email) ? 'online' : 'offline' %>" data-name="<%= (user.name || '').toLowerCase() %>" data-name-original="<%= user.name %>" data-balance="<%= user.balance %>" data-query-credits="<%= user.queryCredits || 0 %>" data-email="<%= (user.email || '').toLowerCase() %>">
                    <td class="ps-3">
                        <input type="checkbox" class="form-check-input">
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="avatar-title avatar-soft-primary rounded-circle fw-semibold d-inline-flex align-items-center justify-content-center">
                                <%= ((user.name || user.email || '?')[0] || '?').toUpperCase() %>
                            </span>
                            <div>
                                <div class="fw-semibold"><%= user.name || user.email %></div>
                                <small class="text-muted"><i class="ti ti-mail me-1"></i><%= user.email %></small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <% const r = Number(user.role); %>
                        <% if (r === 3) { %>
                            <span class="badge badge-warning-soft d-inline-flex align-items-center gap-1"><i class="ti ti-shield-star"></i> Admin</span>
                        <% } else if (r === 2) { %>
                            <span class="badge badge-danger-soft d-inline-flex align-items-center gap-1"><i class="ti ti-crown"></i> VIP</span>
                        <% } else if (r === 1) { %>
                            <span class="badge badge-danger-soft d-inline-flex align-items-center gap-1"><i class="ti ti-user"></i> Normal</span>
                        <% } else { %>
                            <span class="badge badge-primary-soft d-inline-flex align-items-center gap-1"><i class="ti ti-badge"></i> Free</span>
                        <% } %>
                    </td>
                    <td>
                        <span class="badge badge-primary-soft d-inline-flex align-items-center gap-1" style="font-size:12px;"><i class="ti ti-at"></i> <%= user.email %></span>
                    </td>
                    <td>
                        <span class="badge bg-secondary-subtle text-secondary d-inline-flex align-items-center gap-1" style="font-size:12px;"><i class="ti ti-world"></i> <%= user.ip %></span>
                    </td>
                    <td><%= timeAgo(user.joinDate) %></td>
                    <td>
                        <% const lastLogin = lastLoginByEmail[user.email]; const isOnline = onlineEmails.includes(user.email); %>
                        <span class="badge badge-primary-soft d-inline-flex align-items-center gap-1" style="font-size:12px;">
                            <i class="ti ti-login"></i>
                            <%= lastLogin ? timeAgo(lastLogin) : 'Aktif Değil' %>
                        </span>
                        <% if (isOnline) { %>
                            <span class="badge bg-success ms-1">Aktif</span>
                        <% } %>
                    </td>
                    <td>
                        <span class="badge balance-badge"><i class="ti ti-currency-lira"></i> <%= (user.balance || 0) %></span>
                    </td>
                    <td>
                        <span class="badge bg-info-subtle text-info d-inline-flex align-items-center gap-1" style="font-size:12px;"><i class="ti ti-search"></i> <%= user.queryCredits || 0 %></span>
                    </td>
                    <td>
                        <% const online = onlineEmails.includes(user.email); %>
                        <span class="d-inline-flex align-items-center gap-2">
                            <span class="status-dot <%= online ? 'online' : 'offline' %>"></span>
                            <span class="<%= online ? 'text-success' : 'text-muted' %>"><%= online ? 'Aktif' : 'Pasif' %></span>
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="d-flex align-items-center justify-content-center gap-1">
                            <button type="button" class="btn btn-soft-primary btn-icon btn-sm rounded-circle btn-edit" title="Düzenle"
                                    data-bs-toggle="modal" data-bs-target="#editUserModal" data-user-id="<%= user.id %>">
                                <i class="ti ti-edit fs-16"></i>
                            </button>
                            <button type="button" class="btn btn-soft-danger btn-icon btn-sm rounded-circle btn-delete" title="Sil" data-user-id="<%= user.id %>">
                                <i class="ti ti-trash fs-16"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<!-- Kullanıcı Düzenleme Modalı -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2" id="editUserModalLabel">
                    <i class="ti ti-user-edit"></i>
                    Kullanıcı Düzenle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div id="editUserAlert" class="alert d-none" role="alert"></div>
                    <input type="hidden" id="editUserId" name="id">
                    <div class="row g-3">
                        <div class="col-md-6">
                        <label for="userName" class="form-label">Kullanıcı Adı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-user"></i></span>
                                <input type="text" class="form-control" id="userName" name="name" required>
                            </div>
                        </div>
                        <!-- Email alanı kaldırıldı: yalnızca ad/rol/bakiye düzenlenecek -->
                        <div class="col-md-3">
                            <label for="userBalance" class="form-label">Bakiye</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-cash"></i></span>
                                <input type="number" class="form-control" id="userBalance" name="balance" step="1" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="userQueryCredits" class="form-label">Sorgu Hakkı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-search"></i></span>
                                <input type="number" class="form-control" id="userQueryCredits" name="queryCredits" step="1" min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                        <label for="userRole" class="form-label">Rol</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-award"></i></span>
                                <select class="form-select" id="userRole" name="role">
                                    <option value="0">Free</option>
                            <option value="1">Normal</option>
                            <option value="2">VIP</option>
                                 
                        </select>
                    </div>
                        </div>
                        <!-- Durum alanı kaldırıldı: tabloda gösteriliyor, düzenleme dışı -->
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between align-items-center">
                <small class="text-muted">Kaydedildiğinde tablo yenilenecek.</small>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-soft-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" form="editUserForm" id="editUserSubmit" class="btn btn-primary">
                        <i class="ti ti-device-floppy me-1"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yeni Kullanıcı Oluştur Modalı -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2" id="createUserModalLabel">
                    <i class="ti ti-user-plus"></i>
                    Yeni Üye Oluştur
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div id="createUserAlert" class="alert d-none" role="alert"></div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="createUserName" class="form-label">Kullanıcı Adı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-user"></i></span>
                                <input type="text" class="form-control" id="createUserName" name="name" placeholder="Örn. Ahmet Yılmaz" required>
                            </div>
                            <small class="text-muted">Ad 2-64 karakter olmalı ve e‑posta gibi olmamalı.</small>
                        </div>
                        <div class="col-md-6">
                            <label for="createUserEmail" class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-mail"></i></span>
                                <input type="email" class="form-control" id="createUserEmail" name="email" placeholder="ornek@site.com" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="createUserPassword" class="form-label">Şifre</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-lock"></i></span>
                                <input type="password" class="form-control" id="createUserPassword" name="password" minlength="8" placeholder="En az 8 karakter" required>
                            </div>
                            <small class="text-muted">Güçlü bir şifre kullanın.</small>
                        </div>
                        <div class="col-md-3">
                            <label for="createUserRole" class="form-label">Rol</label>
                            <select class="form-select" id="createUserRole" name="role">
                                <option value="0">Free</option>
                                <option value="1" selected>Normal</option>
                                <option value="2">VIP</option>
                            
                        </select>
                        </div>
                        <div class="col-md-3">
                            <label for="createUserBalance" class="form-label">Bakiye</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-cash"></i></span>
                                <input type="number" class="form-control" id="createUserBalance" name="balance" value="0" min="0" step="1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="createUserQueryCredits" class="form-label">Sorgu Hakkı</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="ti ti-search"></i></span>
                                <input type="number" class="form-control" id="createUserQueryCredits" name="queryCredits" value="30" min="0" step="1">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between align-items-center">
                <small class="text-muted">Kullanıcı oluşturulduğunda tablo otomatik yenilenecek.</small>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-soft-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" form="createUserForm" id="createUserSubmit" class="btn btn-primary">
                        <i class="ti ti-device-floppy me-1"></i> Oluştur
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Custom Alert System
function showAlert(message, type = 'success') {
    const alertBox = document.getElementById('userAlert');
    if (!alertBox) return;
    
    alertBox.textContent = message || '';
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('d-none');
    
    setTimeout(() => {
        alertBox.classList.add('d-none');
    }, 4000);
}

// Toast helper (sunucunun döndürdüğü message'ı aynen göster)
function notify(type, message, ms) {
    showAlert(message || (type === 'success' ? 'İşlem başarılı.' : 'İşlem başarısız.'), type);
}
// Kullanıcıyı düzenlemek için butona tıklanıldığında modal'ı açma
document.querySelectorAll('.btn-edit').forEach(button => {
    button.addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const userId = btn.dataset.userId;
        const tr = btn.closest('tr');
        document.getElementById('editUserId').value = userId;
        // Tam ismi data attribute'tan oku (güvenilir)
        document.getElementById('userName').value = (tr?.getAttribute('data-name') || '').trim();
        // Rol, bakiye ve sorgu hakkı
        document.getElementById('userRole').value = String(tr?.getAttribute('data-role') || '1');
        document.getElementById('userBalance').value = String(tr?.getAttribute('data-balance') || '0');
        document.getElementById('userQueryCredits').value = String(tr?.getAttribute('data-query-credits') || '0');
        // status düzenlenmiyor
    });
});

// Edit user form submit handler
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('editUserId').value;
    const name = document.getElementById('userName').value.trim();
    const role = document.getElementById('userRole').value;
    const balance = document.getElementById('userBalance').value;
    const queryCredits = document.getElementById('userQueryCredits').value;
    const submitBtn = document.getElementById('editUserSubmit');
    const alertBox = document.getElementById('editUserAlert');
    alertBox.classList.add('d-none');
    alertBox.textContent='';
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';

    const query = `name=${encodeURIComponent(name)}&role=${encodeURIComponent(role)}&balance=${encodeURIComponent(balance)}&queryCredits=${encodeURIComponent(queryCredits)}`;
    fetch(`/updateUser/${id}?${query}`, {
      method: 'GET',
      headers: { 'x-csrf-token': '<%= csrf %>' },
      credentials: 'same-origin'
    })
      .then(res => res.json())
      .then(data => {
        const msgBox = document.getElementById('editUserAlert');
        if (data?.ok) {
          msgBox.textContent = data.message || 'Güncellendi';
          msgBox.className = 'alert alert-success';
          msgBox.classList.remove('d-none');
          setTimeout(() => location.reload(), 2200);
        } else {
          msgBox.textContent = (data && data.message) || 'Güncellenemedi';
          msgBox.className = 'alert alert-danger';
          msgBox.classList.remove('d-none');
          alertBox.textContent = (data && data.message) || 'Güncellenemedi';
          alertBox.classList.remove('d-none');
        }
      })
      .catch(err => {
        const msgBox = document.getElementById('editUserAlert');
        msgBox.textContent = 'Hata: ' + err;
        msgBox.className = 'alert alert-danger';
        msgBox.classList.remove('d-none');
        alertBox.textContent = 'Hata: ' + err;
        alertBox.classList.remove('d-none');
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="ti ti-device-floppy me-1"></i> Kaydet';
      });
});

// Yeni kullanıcı oluşturma
document.getElementById('createUserForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('createUserName').value.trim();
    const email = document.getElementById('createUserEmail').value.trim().toLowerCase();
    const password = document.getElementById('createUserPassword').value;
    const role = Number(document.getElementById('createUserRole').value);
    const balance = Number(document.getElementById('createUserBalance').value || 0);
    const queryCredits = Number(document.getElementById('createUserQueryCredits').value || 30);
    const alertBox = document.getElementById('createUserAlert');
    const submitBtn = document.getElementById('createUserSubmit');

    alertBox.classList.add('d-none');
    alertBox.textContent = '';
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Oluşturuluyor...';

    fetch('/api/admin/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-csrf-token': '<%= csrf %>'
        },
        body: JSON.stringify({ name, email, password, role, balance, queryCredits })
    })
    .then(res => res.json())
    .then(data => {
        if (data?.ok) {
            // Başarılı: modalı kapat ve listeyi yenile
            const modalEl = document.getElementById('createUserModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            const msgBox = document.getElementById('createUserAlert');
            msgBox.textContent = data.message || 'Kullanıcı oluşturuldu.';
            msgBox.className = 'alert alert-success';
            msgBox.classList.remove('d-none');
            setTimeout(() => location.reload(), 2200);
        } else {
            const msgBox = document.getElementById('createUserAlert');
            msgBox.textContent = data?.message || 'Kullanıcı oluşturulamadı.';
            msgBox.className = 'alert alert-danger';
            msgBox.classList.remove('d-none');
            alertBox.textContent = data?.message || 'Kullanıcı oluşturulamadı.';
            alertBox.classList.remove('d-none');
        }
    })
    .catch(err => {
        alertBox.textContent = 'Bir hata oluştu: ' + err;
        alertBox.classList.remove('d-none');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="ti ti-device-floppy me-1"></i> Oluştur';
    });
});

// (removed legacy filter block to avoid conflict with pagination)

// Basit arama ve sayfalama (client-side)
(function() {
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let searchInput;
    let countEl;
    let paginationEl;
    let table;
    let allRows = [];

    function getFiltered() {
        const q = (searchInput?.value || '').toLowerCase();
        if (!q) return allRows;
        return allRows.filter(tr => {
            const name = tr.getAttribute('data-name') || '';
            const email = tr.getAttribute('data-email') || '';
            return name.includes(q) || email.includes(q);
        });
    }

    function syncPagination(total) {
        if (!paginationEl) return;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        paginationEl.innerHTML = '';
        // prev
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
        prevLi.innerHTML = '<a href="#" class="page-link" data-page="prev"><i class="ti ti-chevrons-left"></i></a>';
        paginationEl.appendChild(prevLi);
        // all pages 1..N
        for (let p = 1; p <= totalPages; p++) {
            const li = document.createElement('li');
            li.className = 'page-item' + (p === currentPage ? ' active' : '');
            li.innerHTML = `<a href="#" class="page-link" data-page="${p}">${p}</a>`;
            paginationEl.appendChild(li);
        }
        // next
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
        nextLi.innerHTML = '<a href="#" class="page-link" data-page="next"><i class="ti ti-chevrons-right"></i></a>';
        paginationEl.appendChild(nextLi);
    }

    function render() {
        const rows = getFiltered();
        const total = rows.length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        // hide/show
        allRows.forEach(tr => tr.style.display = 'none');
        rows.slice(start, end).forEach(tr => tr.style.display = '');
        // counter text
        if (countEl) countEl.textContent = total + ' kullanıcı';
        // pagination
        syncPagination(total);
    }

    paginationEl?.addEventListener('click', function(e) {
        const a = e.target.closest('a.page-link');
        if (!a) return;
        e.preventDefault();
        const target = a.getAttribute('data-page');
        const rows = getFiltered();
        const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
        if (target === 'prev' && currentPage > 1) currentPage--;
        else if (target === 'next' && currentPage < totalPages) currentPage++;
        else if (!isNaN(Number(target))) currentPage = Number(target);
        render();
    });

    searchInput?.addEventListener('input', () => { currentPage = 1; render(); });
    function init() {
        // capture elements after DOM is ready
        searchInput = document.getElementById('search-modal-input');
        countEl = document.getElementById('usersCount');
        paginationEl = document.getElementById('usersPagination');
        table = document.getElementById('usersTable');
        allRows = Array.from((table?.querySelectorAll('tbody tr[data-user-id]')) || []);

        // initial build and bind
        paginationEl?.addEventListener('click', function(e) {
            const a = e.target.closest('a.page-link');
            if (!a) return;
            e.preventDefault();
            const target = a.getAttribute('data-page');
            const rows = getFiltered();
            const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
            if (target === 'prev' && currentPage > 1) currentPage--;
            else if (target === 'next' && currentPage < totalPages) currentPage++;
            else if (!isNaN(Number(target))) currentPage = Number(target);
            render();
        });

        searchInput?.addEventListener('input', () => { currentPage = 1; render(); });

        syncPagination(getFiltered().length);
        render();
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
</script>

<script>
// Kullanıcı silme (SweetAlert onay + backend çağrı)
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-user-id');
        if (!window.Swal) { showAlert('SweetAlert2 yüklü değil', 'danger'); return; }
        Swal.fire({
            title: 'Emin misiniz?',
            text: 'Bu kullanıcı silinecek. Geri alamazsınız.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, sil',
            cancelButtonText: 'Vazgeç'
        }).then((result) => {
            if (!result.isConfirmed) return;
            fetch('/api/admin/users/' + encodeURIComponent(id), {
                method: 'DELETE',
                headers: { 'x-csrf-token': '<%= csrf %>' },
                credentials: 'same-origin'
            }).then(r => r.json())
            .then(resp => {
                if (resp?.ok) {
                    Swal.fire('Silindi', resp.message || 'Kullanıcı silindi', 'success').then(() => location.reload());
                } else {
                    Swal.fire('Hata', (resp && resp.message) || 'Silinemedi', 'error');
                }
            })
            .catch(() => Swal.fire('Hata', 'Silinemedi', 'error'));
        });
    });
});
</script>

                            <div class="card-footer border-0">
                                <div class="d-flex justify-content-end">
                                    <ul class="pagination pagination-boxed mb-0 justify-content-center" id="usersPagination"></ul>
                                </div><!-- end flex -->
                            </div>
                        </div> <!-- end card-->
                    </div> <!-- end col -->
                </div>

            </div> <!-- container -->

   <%- include('includes/footer') %>
            <!-- end Footer -->

        </div>
        <!-- ============================================================== -->
        <!-- End Page content -->
        <!-- ============================================================== -->

    </div>
    <!-- END wrapper -->

    <!-- Theme Settings -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="theme-settings-offcanvas">
        <div class="d-flex align-items-center gap-2 px-3 py-3 offcanvas-header border-bottom border-dashed">
            <h5 class="flex-grow-1 mb-0">Theme Settings</h5>

            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body p-0 h-100" data-simplebar>
            <div class="p-3 border-bottom border-dashed">
                <h5 class="mb-3 fw-bold">Color Scheme</h5>

                <div class="row">
                    <div class="col-4">
                        <div class="form-check card-radio">
                            <input class="form-check-input" type="radio" name="data-bs-theme" id="layout-color-light" value="light">
                            <label class="form-check-label p-3 w-100 d-flex justify-content-center align-items-center" for="layout-color-light">
                                <i class="ti ti-sun fs-32 text-muted"></i>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Light</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check card-radio">
                            <input class="form-check-input" type="radio" name="data-bs-theme" id="layout-color-dark" value="dark">
                            <label class="form-check-label p-3 w-100 d-flex justify-content-center align-items-center" for="layout-color-dark">
                                <i class="ti ti-moon fs-32 text-muted"></i>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Dark</h5>
                    </div>
                </div>
            </div>

            <div class="p-3 border-bottom border-dashed">
                <h5 class="mb-3 fw-bold">Layout Mode</h5>

                <div class="row">
                    <div class="col-4">
                        <div class="form-check card-radio">
                            <input class="form-check-input" type="radio" name="data-layout-mode" id="layout-mode-fluid" value="fluid">
                            <label class="form-check-label p-0 avatar-xl w-100" for="layout-mode-fluid">
                                <div>
                                    <span class="d-flex h-100">
                                        <span class="flex-shrink-0">
                                            <span class="bg-light d-flex h-100 border-end flex-column p-1 px-2">
                                                <span class="d-block p-1 bg-dark-subtle rounded mb-1"></span>
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            </span>
                                        </span>
                                        <span class="flex-grow-1">
                                            <span class="d-flex h-100 flex-column rounded-2">
                                                <span class="bg-light d-block p-1"></span>
                                            </span>
                                        </span>
                                    </span>
                                </div>

                                <div>
                                    <span class="d-flex h-100 flex-column">
                                        <span class="bg-light d-flex p-1 align-items-center border-bottom border-secondary border-opacity-25">
                                            <span class="d-block p-1 bg-dark-subtle rounded me-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-auto"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-1"></span>
                                        </span>
                                        <span class="bg-light d-block p-1"></span>
                                    </span>
                                </div>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Fluid</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-layout-mode" id="data-layout-detached" value="detached">
                            <label class="form-check-label p-0 avatar-xl w-100" for="data-layout-detached">
                                <span class="d-flex h-100 flex-column">
                                    <span class="bg-light d-flex p-1 align-items-center border-bottom ">
                                        <span class="d-block p-1 bg-dark-subtle rounded me-1"></span>
                                        <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-auto"></span>
                                        <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-1"></span>
                                        <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-1"></span>
                                        <span class="d-block border border-3 border-secondary border-opacity-25 rounded ms-1"></span>
                                    </span>
                                    <span class="d-flex h-100 p-1 px-2">
                                        <span class="flex-shrink-0">
                                            <span class="bg-light d-flex h-100 flex-column p-1 px-2">
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                                <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100"></span>
                                            </span>
                                        </span>
                                    </span>
                                    <span class="bg-light d-block p-1 mt-auto px-2"></span>
                                </span>

                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Detached</h5>
                    </div>
                </div>
            </div>

            <div class="p-3 border-bottom border-dashed">
                <h5 class="mb-3 fw-bold">Topbar Color</h5>

                <div class="row">
                    <div class="col-3">
                        <div class="form-check card-radio">
                            <input class="form-check-input" type="radio" name="data-topbar-color" id="topbar-color-light" value="light">
                            <label class="form-check-label border-0 p-0 avatar-lg w-100 bg-light bg-opacity-50" for="topbar-color-light">
                                <span class="d-flex align-items-center justify-content-center h-100">
                                    <span class="p-2 d-inline-flex shadow rounded-circle bg-white"></span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Light</h5>
                    </div>

                    <div class="col-3" style="--ct-dark-rgb: 64,73,84;">
                        <div class="form-check card-radio">
                            <input class="form-check-input" type="radio" name="data-topbar-color" id="topbar-color-dark" value="dark">
                            <label class="form-check-label border-0 p-0 avatar-lg w-100 bg-light bg-opacity-50" for="topbar-color-dark">
                                <span class="d-flex align-items-center justify-content-center h-100">
                                    <span class="p-2 d-inline-flex shadow rounded-circle bg-dark"></span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Dark</h5>
                    </div>
                </div>
            </div>

            <div class="p-3 border-bottom border-dashed">
                <h5 class="mb-3 fw-bold">Menu Color</h5>

                <div class="row">
                    <div class="col-3">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-menu-color" id="sidenav-color-light" value="light">
                            <label class="form-check-label border-0 p-0 avatar-lg w-100 bg-light bg-opacity-50" for="sidenav-color-light">
                                <span class="d-flex align-items-center justify-content-center h-100">
                                    <span class="p-2 d-inline-flex shadow rounded-circle bg-white"></span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Light</h5>
                    </div>

                    <div class="col-3" style="--ct-dark-rgb: 64,73,84;">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-menu-color" id="sidenav-color-dark" value="dark">
                            <label class="form-check-label border-0 p-0 avatar-lg w-100 bg-light bg-opacity-50" for="sidenav-color-dark">
                                <span class="d-flex align-items-center justify-content-center h-100">
                                    <span class="p-2 d-inline-flex shadow rounded-circle bg-dark"></span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Dark</h5>
                    </div>
                </div>
            </div>

            <div class="p-3 .border-bottom .border-dashed">
                <h5 class="mb-3 fw-bold">Sidebar Size</h5>

                <div class="row">
                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-sidenav-size" id="sidenav-size-default" value="default">
                            <label class="form-check-label p-0 avatar-xl w-100" for="sidenav-size-default">
                                <span class="d-flex h-100">
                                    <span class="flex-shrink-0">
                                        <span class="bg-light d-flex h-100 border-end  flex-column p-1 px-2">
                                            <span class="d-block p-1 bg-dark-subtle rounded mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                        </span>
                                    </span>
                                    <span class="flex-grow-1">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="bg-light d-block p-1"></span>
                                        </span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2 mb-3">Default</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-sidenav-size" id="sidenav-size-compact" value="compact">
                            <label class="form-check-label p-0 avatar-xl w-100" for="sidenav-size-compact">
                                <span class="d-flex h-100">
                                    <span class="flex-shrink-0">
                                        <span class="bg-light d-flex h-100 border-end  flex-column p-1">
                                            <span class="d-block p-1 bg-dark-subtle rounded mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                        </span>
                                    </span>
                                    <span class="flex-grow-1">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="bg-light d-block p-1"></span>
                                        </span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2 mb-3">Compact</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-sidenav-size" id="sidenav-size-small" value="condensed">
                            <label class="form-check-label p-0 avatar-xl w-100" for="sidenav-size-small">
                                <span class="d-flex h-100">
                                    <span class="flex-shrink-0">
                                        <span class="bg-light d-flex h-100 border-end flex-column" style="padding: 2px;">
                                            <span class="d-block p-1 bg-dark-subtle rounded mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                        </span>
                                    </span>
                                    <span class="flex-grow-1">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="bg-light d-block p-1"></span>
                                        </span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2 mb-3">Condensed</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-sidenav-size" id="sidenav-size-small-hover" value="sm-hover">
                            <label class="form-check-label p-0 avatar-xl w-100" for="sidenav-size-small-hover">
                                <span class="d-flex h-100">
                                    <span class="flex-shrink-0">
                                        <span class="bg-light d-flex h-100 border-end flex-column" style="padding: 2px;">
                                            <span class="d-block p-1 bg-dark-subtle rounded mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                            <span class="d-block border border-3 border-secondary border-opacity-25 rounded w-100 mb-1"></span>
                                        </span>
                                    </span>
                                    <span class="flex-grow-1">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="bg-light d-block p-1"></span>
                                        </span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Hover View</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-sidenav-size" id="sidenav-size-full" value="full">
                            <label class="form-check-label p-0 avatar-xl w-100" for="sidenav-size-full">
                                <span class="d-flex h-100">
                                    <span class="flex-shrink-0">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="d-block p-1 bg-dark-subtle mb-1"></span>
                                        </span>
                                    </span>
                                    <span class="flex-grow-1">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="bg-light d-block p-1"></span>
                                        </span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Full Layout</h5>
                    </div>

                    <div class="col-4">
                        <div class="form-check sidebar-setting card-radio">
                            <input class="form-check-input" type="radio" name="data-sidenav-size" id="sidenav-size-fullscreen" value="fullscreen">
                            <label class="form-check-label p-0 avatar-xl w-100" for="sidenav-size-fullscreen">
                                <span class="d-flex h-100">
                                    <span class="flex-grow-1">
                                        <span class="d-flex h-100 flex-column">
                                            <span class="bg-light d-block p-1"></span>
                                        </span>
                                    </span>
                                </span>
                            </label>
                        </div>
                        <h5 class="fs-13 fw-semibold text-center text-muted mt-2">Hidden</h5>
                    </div>
                </div>
            </div>

            <div class="p-3 border-bottom border-dashed d-none">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="fs-16 fw-bold mb-0">Container Width</h5>

                    <div class="btn-group radio" role="group">
                        <input type="radio" class="btn-check" name="data-container-position" id="container-width-fixed" value="fixed">
                        <label class="btn btn-sm btn-soft-primary w-sm" for="container-width-fixed">Full</label>

                        <input type="radio" class="btn-check" name="data-container-position" id="container-width-scrollable" value="scrollable">
                        <label class="btn btn-sm btn-soft-primary w-sm ms-0" for="container-width-scrollable">Boxed</label>
                    </div>
                </div>
            </div>

            <div class="p-3 border-bottom border-dashed d-none">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="fs-16 fw-bold mb-0">Layout Position</h5>

                    <div class="btn-group radio" role="group">
                        <input type="radio" class="btn-check" name="data-layout-position" id="layout-position-fixed" value="fixed">
                        <label class="btn btn-sm btn-soft-primary w-sm" for="layout-position-fixed">Fixed</label>

                        <input type="radio" class="btn-check" name="data-layout-position" id="layout-position-scrollable" value="scrollable">
                        <label class="btn btn-sm btn-soft-primary w-sm ms-0" for="layout-position-scrollable">Scrollable</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2 px-3 py-2 offcanvas-header border-top border-dashed">
            <button type="button" class="btn w-50 btn-soft-danger" id="reset-layout">Reset</button>
            <button type="button" class="btn w-50 btn-soft-info">Buy Now</button>
        </div>

    </div>

    <!-- Vendor js -->
    <script src="assets/js/vendor.min.js"></script>

    <!-- App js -->
    <script src="assets/js/app.js"></script>

</body>

</html>